name: Release

on:
  push:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  VERSION: 1.0.${{ github.run_number }}

jobs:
  build:
    name: Build ${{ matrix.friendly_name }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-musl
            runner: ubuntu-latest
            use_cross: true
            friendly_name: linux-x64
          - target: aarch64-unknown-linux-musl
            runner: ubuntu-latest
            use_cross: true
            friendly_name: linux-arm64
          - target: x86_64-apple-darwin
            runner: macos-latest
            use_cross: false
            friendly_name: darwin-x64
          - target: aarch64-apple-darwin
            runner: macos-latest
            use_cross: false
            friendly_name: darwin-arm64
          - target: x86_64-pc-windows-msvc
            runner: windows-latest
            use_cross: false
            friendly_name: windows-x64
          - target: aarch64-pc-windows-msvc
            runner: windows-latest
            use_cross: false
            friendly_name: windows-arm64

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Install cross
        if: matrix.use_cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build (cross)
        if: matrix.use_cross
        run: cross build --release --bin sirrd --bin sirr --target ${{ matrix.target }}

      - name: Build (cargo)
        if: "!matrix.use_cross"
        run: cargo build --release --bin sirrd --bin sirr --target ${{ matrix.target }}

      - name: Package (Unix)
        if: runner.os != 'Windows'
        shell: bash
        env:
          FRIENDLY_NAME: ${{ matrix.friendly_name }}
          TARGET: ${{ matrix.target }}
        run: |
          SIRRD_BIN=target/${TARGET}/release/sirrd
          SIRR_BIN=target/${TARGET}/release/sirr

          SIRRD_ARCHIVE=sirrd-${FRIENDLY_NAME}.tar.gz
          cp "$SIRRD_BIN" sirrd
          tar czf "$SIRRD_ARCHIVE" sirrd
          rm sirrd
          (sha256sum "$SIRRD_ARCHIVE" 2>/dev/null || shasum -a 256 "$SIRRD_ARCHIVE") > "$SIRRD_ARCHIVE.sha256"

          SIRR_ARCHIVE=sirr-${FRIENDLY_NAME}.tar.gz
          cp "$SIRR_BIN" sirr
          tar czf "$SIRR_ARCHIVE" sirr
          rm sirr
          (sha256sum "$SIRR_ARCHIVE" 2>/dev/null || shasum -a 256 "$SIRR_ARCHIVE") > "$SIRR_ARCHIVE.sha256"

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          FRIENDLY_NAME: ${{ matrix.friendly_name }}
          TARGET: ${{ matrix.target }}
        run: |
          $sirrdSrc = "target\$env:TARGET\release\sirrd.exe"
          $sirrdZip = "sirrd-$env:FRIENDLY_NAME.zip"
          Compress-Archive -Path $sirrdSrc -DestinationPath $sirrdZip
          (Get-FileHash $sirrdZip -Algorithm SHA256).Hash.ToLower() + "  $sirrdZip" | Out-File "$sirrdZip.sha256" -Encoding ascii

          $sirrSrc = "target\$env:TARGET\release\sirr.exe"
          $sirrZip = "sirr-$env:FRIENDLY_NAME.zip"
          Compress-Archive -Path $sirrSrc -DestinationPath $sirrZip
          (Get-FileHash $sirrZip -Algorithm SHA256).Hash.ToLower() + "  $sirrZip" | Out-File "$sirrZip.sha256" -Encoding ascii

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sirrd-${{ matrix.friendly_name }}
          path: |
            sirrd-*.tar.gz
            sirrd-*.zip
            sirr-*.tar.gz
            sirr-*.zip
            *.sha256

  github-release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          files: artifacts/**
          generate_release_notes: true

  docker:
    name: Docker image
    runs-on: ubuntu-latest
    needs: build
    permissions:
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - uses: actions/download-artifact@v4
        with:
          name: sirrd-linux-x64
          path: dist-x86_64

      - uses: actions/download-artifact@v4
        with:
          name: sirrd-linux-arm64
          path: dist-aarch64

      - name: Prepare binaries
        run: |
          mkdir -p dist/amd64 dist/arm64
          tar xzf dist-x86_64/sirrd-linux-x64.tar.gz -C dist/amd64
          tar xzf dist-aarch64/sirrd-linux-arm64.tar.gz -C dist/arm64
          chmod +x dist/amd64/sirrd dist/arm64/sirrd

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.release
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/sirrvault/sirrd:v${{ steps.version.outputs.version }}
            ghcr.io/sirrvault/sirrd:latest
            sirrvault/sirrd:v${{ steps.version.outputs.version }}
            sirrvault/sirrd:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set workspace version
        env:
          VER: ${{ env.VERSION }}
        run: |
          sed -i "s/^version = \"[^\"]*\"/version = \"${VER}\"/" Cargo.toml
          sed -i "s/sirr-server = { path = \"[^\"]*\", version = \"[^\"]*\" }/sirr-server = { path = \"crates\/sirr-server\", version = \"${VER}\" }/" Cargo.toml

      - name: Check if version already published
        id: check
        env:
          VER: ${{ env.VERSION }}
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "User-Agent: distros-check/1.0" \
            "https://crates.io/api/v1/crates/sirrd/${VER}")
          if [ "$STATUS" = "200" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "sirrd v${VER} already on crates.io — skipping"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "sirrd v${VER} not yet published — will publish"
          fi

      - name: Publish sirr-server
        if: steps.check.outputs.skip == 'false'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish -p sirr-server --allow-dirty --token "$CARGO_REGISTRY_TOKEN"

      - name: Wait for crates.io to index sirr-server
        if: steps.check.outputs.skip == 'false'
        run: sleep 30

      - name: Publish sirrd
        if: steps.check.outputs.skip == 'false'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish -p sirrd --allow-dirty --token "$CARGO_REGISTRY_TOKEN"

      - name: Wait for crates.io to index sirrd
        if: steps.check.outputs.skip == 'false'
        run: sleep 30

      - name: Publish sirr
        if: steps.check.outputs.skip == 'false'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish -p sirr --allow-dirty --token "$CARGO_REGISTRY_TOKEN"

  update-homebrew:
    name: Update Homebrew formulas (sirrd + sirr)
    runs-on: ubuntu-latest
    needs: github-release
    permissions:
      contents: read

    steps:
      - name: Get version
        id: version
        run: echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Extract sha256 hashes
        id: sha256
        run: |
          echo "sirrd_darwin_arm64=$(awk '{print $1}' artifacts/sirrd-darwin-arm64.tar.gz.sha256)" >> $GITHUB_OUTPUT
          echo "sirrd_darwin_x64=$(awk '{print $1}'   artifacts/sirrd-darwin-x64.tar.gz.sha256)"   >> $GITHUB_OUTPUT
          echo "sirrd_linux_arm64=$(awk '{print $1}'  artifacts/sirrd-linux-arm64.tar.gz.sha256)"   >> $GITHUB_OUTPUT
          echo "sirrd_linux_x64=$(awk '{print $1}'    artifacts/sirrd-linux-x64.tar.gz.sha256)"     >> $GITHUB_OUTPUT
          echo "sirr_darwin_arm64=$(awk '{print $1}'  artifacts/sirr-darwin-arm64.tar.gz.sha256)"   >> $GITHUB_OUTPUT
          echo "sirr_darwin_x64=$(awk '{print $1}'    artifacts/sirr-darwin-x64.tar.gz.sha256)"     >> $GITHUB_OUTPUT
          echo "sirr_linux_arm64=$(awk '{print $1}'   artifacts/sirr-linux-arm64.tar.gz.sha256)"    >> $GITHUB_OUTPUT
          echo "sirr_linux_x64=$(awk '{print $1}'     artifacts/sirr-linux-x64.tar.gz.sha256)"      >> $GITHUB_OUTPUT

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: SirrVault/homebrew-tap
          token: ${{ secrets.SIRR_PACKAGE_MANAGERS_KEY }}
          path: homebrew-tap

      - name: Update formulas
        env:
          VERSION:           ${{ steps.version.outputs.version }}
          SIRRD_DARWIN_ARM64: ${{ steps.sha256.outputs.sirrd_darwin_arm64 }}
          SIRRD_DARWIN_X64:   ${{ steps.sha256.outputs.sirrd_darwin_x64 }}
          SIRRD_LINUX_ARM64:  ${{ steps.sha256.outputs.sirrd_linux_arm64 }}
          SIRRD_LINUX_X64:    ${{ steps.sha256.outputs.sirrd_linux_x64 }}
          SIRR_DARWIN_ARM64:  ${{ steps.sha256.outputs.sirr_darwin_arm64 }}
          SIRR_DARWIN_X64:    ${{ steps.sha256.outputs.sirr_darwin_x64 }}
          SIRR_LINUX_ARM64:   ${{ steps.sha256.outputs.sirr_linux_arm64 }}
          SIRR_LINUX_X64:     ${{ steps.sha256.outputs.sirr_linux_x64 }}
        run: |
          python3 - <<'EOF'
          import re, os

          def update_formula(path, ver, hashes):
              with open(path) as f:
                  text = f.read()
              text = re.sub(r'(  version )"[^"]*"', rf'\1"{ver}"', text)
              for platform, sha in hashes.items():
                  text = re.sub(
                      rf'(url "[^"]*{re.escape(platform)}[^"]*"\n\s+sha256 )"[^"]*"',
                      rf'\1"{sha}"',
                      text,
                  )
              with open(path, 'w') as f:
                  f.write(text)
              print(f"Updated {path} to v{ver}")

          ver = os.environ['VERSION']

          update_formula('homebrew-tap/Formula/sirrd.rb', ver, {
              'darwin-arm64': os.environ['SIRRD_DARWIN_ARM64'],
              'darwin-x64':   os.environ['SIRRD_DARWIN_X64'],
              'linux-arm64':  os.environ['SIRRD_LINUX_ARM64'],
              'linux-x64':    os.environ['SIRRD_LINUX_X64'],
          })

          update_formula('homebrew-tap/Formula/sirr.rb', ver, {
              'darwin-arm64': os.environ['SIRR_DARWIN_ARM64'],
              'darwin-x64':   os.environ['SIRR_DARWIN_X64'],
              'linux-arm64':  os.environ['SIRR_LINUX_ARM64'],
              'linux-x64':    os.environ['SIRR_LINUX_X64'],
          })
          EOF

      - name: Commit and push
        working-directory: homebrew-tap
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/sirrd.rb Formula/sirr.rb
          git diff --staged --quiet || git commit -m "chore: bump sirrd + sirr to v${VERSION}"
          git push

  update-scoop:
    name: Update Scoop manifests (sirrd + sirr)
    runs-on: ubuntu-latest
    needs: github-release
    permissions:
      contents: read

    steps:
      - name: Get version
        id: version
        run: echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Extract sha256 hashes
        id: sha256
        run: |
          echo "sirrd_win_x64=$(awk '{print $1}'  artifacts/sirrd-windows-x64.zip.sha256)"  >> $GITHUB_OUTPUT
          echo "sirr_win_x64=$(awk '{print $1}'   artifacts/sirr-windows-x64.zip.sha256)"   >> $GITHUB_OUTPUT
          echo "sirr_win_arm64=$(awk '{print $1}' artifacts/sirr-windows-arm64.zip.sha256)" >> $GITHUB_OUTPUT

      - name: Checkout scoop-bucket
        uses: actions/checkout@v4
        with:
          repository: SirrVault/scoop-bucket
          token: ${{ secrets.SIRR_PACKAGE_MANAGERS_KEY }}
          path: scoop-bucket

      - name: Update manifests
        env:
          VERSION:          ${{ steps.version.outputs.version }}
          SIRRD_WIN_X64:    ${{ steps.sha256.outputs.sirrd_win_x64 }}
          SIRR_WIN_X64:     ${{ steps.sha256.outputs.sirr_win_x64 }}
          SIRR_WIN_ARM64:   ${{ steps.sha256.outputs.sirr_win_arm64 }}
        run: |
          python3 - <<'EOF'
          import json, os

          ver = os.environ['VERSION']

          def write(path, manifest):
              with open(path, 'w') as f:
                  json.dump(manifest, f, indent=2)
                  f.write('\n')
              print(f"Updated {path} to v{ver}")

          with open('scoop-bucket/bucket/sirrd.json') as f:
              m = json.load(f)
          m['version'] = ver
          m['architecture']['64bit']['url'] = f'https://github.com/SirrVault/sirr/releases/download/v{ver}/sirrd-windows-x64.zip'
          m['architecture']['64bit']['hash'] = os.environ['SIRRD_WIN_X64']
          write('scoop-bucket/bucket/sirrd.json', m)

          with open('scoop-bucket/bucket/sirr.json') as f:
              m = json.load(f)
          m['version'] = ver
          m['architecture']['64bit']['url']  = f'https://github.com/SirrVault/sirr/releases/download/v{ver}/sirr-windows-x64.zip'
          m['architecture']['64bit']['hash']  = os.environ['SIRR_WIN_X64']
          m['architecture']['arm64']['url']  = f'https://github.com/SirrVault/sirr/releases/download/v{ver}/sirr-windows-arm64.zip'
          m['architecture']['arm64']['hash'] = os.environ['SIRR_WIN_ARM64']
          write('scoop-bucket/bucket/sirr.json', m)
          EOF

      - name: Commit and push
        working-directory: scoop-bucket
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add bucket/sirrd.json bucket/sirr.json
          git diff --staged --quiet || git commit -m "chore: bump sirrd + sirr to v${VERSION}"
          git push
